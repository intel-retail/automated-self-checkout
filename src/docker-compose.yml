#
# Copyright (C) 2024 Intel Corporation.
#
# SPDX-License-Identifier: Apache-2.0
#


 ## Current Developer Toolbox doesn't support environment files, make sure to remove any files or environment variables starting with $
version: '3.7'
services:
  camera-simulator:
    container_name: camera-simulator
    image: aler9/rtsp-simple-server
    ports:
      - "127.0.0.1:8554:8554"
  camera-simulator0:
    image: jrottenberg/ffmpeg:4.1-alpine
    container_name: camera-simulator0
    network_mode: "host"
    entrypoint: ["/bin/sh","-c"]
    command: 
    - | 
       if [ ! -f /home/pipeline-server/sample-media/coca-cola-4465029-1920-15-bench.mp4 ]; then
          mkdir -p /home/pipeline-server/sample-media
          wget -O /home/pipeline-server/sample-media/coca-cola-4465029-1920-15-bench.mp4 https://www.pexels.com/download/video/4465029
       fi
       ffmpeg -nostdin -re -stream_loop -1 -i /home/pipeline-server/sample-media/coca-cola-4465029-1920-15-bench.mp4 -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/camera_0
    depends_on:
      - camera-simulator
    volumes:
      - ${RETAIL_USE_CASE_ROOT:-..}/performance-tools/sample-media:/home/pipeline-server/sample-media

  OvmsClientGst:
    image: dlstreamer:dev
    deploy:
      mode: replicated
      replicas: ${PIPELINE_COUNT:-1}
    network_mode: "host"
    entrypoint: /script/entrypoint.sh --pipeline_script_choice ${PIPELINE_SCRIPT:-yolov5s.sh}
    privileged: true
    ipc: "host"
    env_file:
      - .env
      - ${DEVICE_ENV:-res/all-cpu.env}
    environment:
      - CONTAINER_NAME=${CONTAINER_NAME}
      - INPUTSRC=${INPUTSRC}
      - RENDER_MODE=${RENDER_MODE}
      - DISPLAY=${DISPLAY}
    volumes:
      - ${RESULTS_DIR:-../results}:/tmp/results
      - ~/.Xauthority:/home/dlstreamer/.Xauthority
      - /tmp/.X11-unix
      - ~/.cl-cache:/home/pipeline-server/.cl-cache
      - ./res/:/home/pipeline-server/envs
      - ${RETAIL_USE_CASE_ROOT:-..}/models:/home/pipeline-server/models

  
  
  mqtt-broker_1:
    container_name: mqtt-broker_1
    image: eclipse-mosquitto:2.0.18
    ports:
      - "1884:1883"  # External port 1884 mapped to internal port 1883
    volumes:
    - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
    restart: unless-stopped

    

  lidar-service:
    build:
      context: ./lidar-service
      dockerfile: Dockerfile
    image: asc-lidar-service:latest
    container_name: asc_lidar_service
    environment:
      - SENSOR_ID=lidar-001
      - MOCK_SENSOR=true           # set to 'false' when using real hardware
      - MQTT_ENABLE=true
      - MQTT_BROKER_HOST=mqtt-broker_1 # or 'localhost'
      - MQTT_BROKER_PORT=1883
      - KAFKA_ENABLE=false
      - HTTP_ENABLE=false
      - PUBLISH_INTERVAL=1.0       # 1 second interval
      - LOG_LEVEL=INFO

    depends_on:
      - mqtt-broker_1
  
  weight-service:
    build:
      context: ./weight-service
      dockerfile: Dockerfile
    image: asc-weight-service:latest
    container_name: asc_weight_service
    environment:
      - SENSOR_ID=weight-001
      - MOCK_SENSOR=true           # set to 'false' when using real hardware
      - MQTT_ENABLE=true
      - MQTT_BROKER_HOST=mqtt-broker_1 # or 'localhost'
      - MQTT_BROKER_PORT=1883
      - KAFKA_ENABLE=false
      - HTTP_ENABLE=false
      - PUBLISH_INTERVAL=1.0       # 1 second interval
      - LOG_LEVEL=INFO

    depends_on:
      - mqtt-broker_1
    
    restart: unless-stopped
  
  peripheral-analytics:
    build:
      context: ./peripheral-analytics
      dockerfile: Dockerfile
    image: asc-peripheral-analytics:latest
    container_name: asc_peripheral_analytics
    environment:
      - MQTT_BROKER_HOST=mqtt-broker_1
      - MQTT_BROKER_PORT=1883
      - MQTT_TOPIC=peripheral-analytics
      - MQTT_QOS=1
      - MQTT_CLIENT_ID=peripheral-analytics
      - LOG_LEVEL=INFO
    depends_on:
      - mqtt-broker_1
    restart: unless-stopped

  

  grafana:
    container_name: my_grafana
    image: grafana/grafana-oss:latest
    depends_on:
      - mqtt-broker_1
    ports:
      - "3000:3000"
    restart: unless-stopped